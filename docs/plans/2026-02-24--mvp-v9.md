# MVP v9 설계 문서 (Brainstorming)

- 작성일: 2026-02-24
- 범위: 동양 오컬트 타로 챗 MVP v9
- 목적: 코딩 이전, 상태/API/UX/운영 정책을 단일 문서로 고정

## 1) 문제 정의와 성공 기준

### 목표
- 무료 1회 체험과 유료(990원) 전환을 하나의 일관된 여정으로 구성한다.
- 결제 성공 사용자는 저장 실패가 일부 발생해도 해금 경험이 끊기지 않게 한다.
- 과도한 기술 메시지 없이 오컬트 톤을 유지하며 실패 UX를 안내한다.

### 비목표 (MVP 제외)
- 번들/구독 다중 상품
- 남은 시간 카운트다운 UI
- 복잡한 멀티디바이스 동기화 보장

### 성공 지표
- 무료→유료 전환 흐름에서 결제 후 해금 실패율 최소화
- 429 이후 반복 팝업 0회 (최초 1회만 노출)
- 유료 세션(24h) 내 질의 카운터 일관성 유지

## 2) 설계 접근안 (2~3안)

### 접근 A (권장): JWT 권한 + Redis 세션 카운터 분리
- 구성: 결제 성공 시 HS256 JWT(entitlement) 발급, 사용량(q/d)은 Redis 세션에서 차감
- 장점: 권한 증명과 상태 차감을 분리해 장애 격리 가능
- 단점: JWT 발급 성공/Redis 실패의 불일치 처리 필요

### 접근 B: Redis 단일 소스(권한+카운터)
- 구성: JWT 최소화하고 Redis 조회로만 권한/카운터 판정
- 장점: 상태 단일화
- 단점: Redis 장애 시 전체 유료 플로우 중단, UX/CS 리스크 큼

### 접근 C: JWT 내 카운터 포함(서버 무상태)
- 구성: 매 요청마다 재서명 토큰 회전
- 장점: Redis 의존 축소
- 단점: 토큰 동시성/재발급 복잡도 증가, MVP 과설계

### 결론
- **접근 A 채택**: MVP 요구(관대한 단순 로직 허용)와 결제 이탈 방어 요구를 동시에 만족.

## 3) 아키텍처 개요

- 클라이언트: 부트스트랩 상태 + 로컬 복구 플래그 + 표시 전용 상태머신
- API 계층:
  - `/api/bootstrap`: 하루/운영 상태만 제공
  - `/api/verify-payment`: 결제 검증 및 entitlement 발급 책임
  - `/api/tarot/free`: 무료 3장+티저
  - `/api/tarot/paid-summary`: 유료 질문(요약)
  - `/api/tarot/paid-detail`: 유료 자세히(1회)
- 데이터:
  - JWT: entitlement 권한 증명
  - Upstash Redis: 세션 카운터(q=3,d=1), TTL=86400

## 4) 상태머신 설계

### 공통 상태 키
- `todayKst`: 서버 기준 KST 날짜 문자열 (예: `2026-02-24`)
- `freeAvailable`: 오늘 무료 질문 가능 여부 (`lastFreeUsedKst < todayKst`)
- `rateLimitNotifiedKst`: 429 팝업을 이미 보여준 날짜
- `PAYMENT_IN_PROGRESS` (localStorage): 결제창 이탈/복귀 복구 플래그
- `entitlementJwt`: 유료 접근 토큰
- `paidSession`: Redis 세션 상태 `{ qRemaining: 3, dRemaining: 1, expiresAt }`

### 무료 플로우 상태 전이
1. `BOOTSTRAP_DONE`에서 `todayKst` 수신
2. `freeAvailable` 계산
3. 무료 요청 성공 시:
- 서버가 일일 무료 소진 기록 반영
- 클라 `lastFreeUsedKst = todayKst`
4. 무료 레이트리밋 초과(429) 시:
- `rateLimitNotifiedKst !== todayKst`이면 팝업 1회 후 `rateLimitNotifiedKst=todayKst`
- 이후 당일은 팝업 없이 입력창 `disabled`

### 결제 복구 상태 전이
1. 결제 시작 직전: `PAYMENT_IN_PROGRESS=true`
2. 앱 복귀 시 플래그 감지 → `/api/verify-payment` 호출
3. PAID 확인 시:
- Redis 저장 성공/실패와 무관하게 JWT 발급
- `PAYMENT_IN_PROGRESS` 제거
4. PAID 아님/검증 실패 시:
- 플래그 제거 또는 재시도 정책 적용

### 유료 세션 상태 전이
1. JWT 유효 + Redis 세션 조회(없으면 초기화 가능)
2. `/paid-summary` 호출 시 q 차감 규칙:
- Q1, Q2: 새 5장 뽑기 + `qRemaining--`
- Q3: 보조 1장 + `qRemaining--`
3. `/paid-detail` 호출 시 `dRemaining--` (최대 1회)
4. TTL 24h 도달 시 숨은 만료 처리 (UI에 시간 노출 금지)

## 5) API 계약 (MVP)

### 5.1 `GET /api/bootstrap`
- 응답 필수 필드:
- `todayKst: string`
- `budgetExhausted: boolean`
- `maintenanceMode: boolean`
- 제약:
- 레이트리밋 잔여치 포함 금지
- 앱 마운트 시 1회 호출

### 5.2 `POST /api/verify-payment`
- 입력: 결제 식별자(주문번호/트랜잭션 키)
- 처리:
- PG 상태 확인
- `PAID`면 entitlement JWT 발급(필수)
- Redis 세션 저장 실패해도 JWT 발급 유지
- 응답:
- `paid: boolean`
- `entitlementJwt?: string`
- `sessionInitStatus: "ok" | "degraded"`

### 5.3 `POST /api/tarot/free`
- 인증: 불필요(익명/IP 기반)
- 정책:
- 오늘 첫 질문 1회 + IP당 5회/일 제한
- 응답:
- 3장 스프레드
- 티저(함정) 1단어
- 에러:
- 429 시 UX 규칙 적용(최초 1회 팝업)

### 5.4 `POST /api/tarot/paid-summary`
- 인증: `Authorization: Bearer <JWT>` 필수
- 서버 검증:
- HS256 검증 + 세션 카운터 차감
- 응답:
- Q1~Q2: 5장 요약
- Q3: 보조 1장 요약
- 에러:
- 토큰 없음/실패/만료, 카운터 소진

### 5.5 `POST /api/tarot/paid-detail`
- 인증: `Authorization: Bearer <JWT>` 필수
- 서버 검증:
- HS256 검증 + `dRemaining > 0` 확인 후 차감
- 응답:
- 자세히 해설(1회)

## 6) UX 정책 상세

### 429 처리 UX
- 429 최초 발생(당일): 팝업 1회
- 이후 당일 반복 429:
- 팝업 재노출 금지
- 입력창 `disabled`
- placeholder/tooltip로 사유 안내

### JWT 실패 UX (IT 용어 금지)
- 금지 표현: 토큰, 인증 실패, 401, 시그니처, 세션 만료(기술형)
- 안내 문구 톤:
- "지금은 기운이 흩어져 해석이 닿지 않아요."
- CTA:
- "990원으로 다시 길을 열기"

### UNLOCK UX
- 해금 텍스트 출력: Typewriter 40ms/자, 최대 80자
- Typewriter 종료 직후:
- `자세히(1회)` 버튼 Pulse 1~2회
- 색상: `occult-accent` 기반
- 접근성:
- `prefers-reduced-motion` 시 타이핑/펄스 완화 또는 정적 표시

### 광고 UX
- 무료 사용자에게만 노출
- CLS 방지: 고정 높이 placeholder 유지
- 모바일 키보드 활성 시 광고 숨김

## 7) 카테고리 모델

### 고정 + 동적 슬롯
- `pinned` 4개(하드코딩, 교체 금지)
- `dynamic` 2개(AI 생성/교체)

### 교체 규칙
- LRU 기준: `lastUsedAt`이 가장 오래된 dynamic 카테고리 교체

### 스프레드 포지션
- 카테고리별 3장/5장 포지션 맵 분리 유지
- 동일 카드 수라도 카테고리별 위치 의미가 달라야 함

## 8) 리스크 단어 정책

### 블랙리스트(직접 단정 금지)
- 사망 확정, 질병 확진, 범죄 단정, 임신/불임 단정, 투자 수익 보장, 파산 확정

### 가이드
- 단정형 대신 가능성/조언형 문장 사용
- 의료/법률/투자 조언으로 오해될 문구는 완곡화
- 이용자 불안 증폭 단어(재앙, 저주 확정 등) 최소화

### fallback
- 모델 출력이 블랙리스트 충돌 시:
1. 안전 템플릿으로 재작성
2. 필요 시 일반 조언형 짧은 해석으로 강등
3. 반복 충돌 시 "지금은 흐름이 불안정해 짧게 전합니다" 메시지 반환

## 9) 에러 처리 및 운영 원칙

- `maintenanceMode=true` 시 질문 입력 차단 + 점검 안내
- `budgetExhausted=true` 시 무료 유도 축소, 유료 우선 안내
- Redis 장애 시:
- 무료는 가능한 범위에서 유지
- 유료는 verify-payment에서 JWT 우선 발급(UX 보존)

## 10) 테스트/검증 계획 (설계 수준)

- 상태머신 테스트:
- KST 날짜 경계(23:59~00:00)에서 freeAvailable 전환
- 429 팝업 1회/일 보장
- PAYMENT_IN_PROGRESS 복구 시나리오
- API 계약 테스트:
- bootstrap 필드 누락/초과 데이터 검증
- verify-payment의 PAID+Redis 실패 경로
- 유료 카운터(q/d) 차감 규칙
- UX 점검:
- JWT 실패 문구 비기술 톤 준수
- reduced-motion에서 애니메이션 완화

## 11) TODO 티켓 (우선순위 포함, 16개)

1. **[P0] 부트스트랩 API 계약 고정**  
   - `/api/bootstrap` 응답을 `todayKst,budgetExhausted,maintenanceMode`로 고정하고 잔여치 제거.
2. **[P0] KST 기준 무료 1회 상태 계산 설계 반영**  
   - `freeAvailable` 계산 규칙과 저장 키(`lastFreeUsedKst`) 정의.
3. **[P0] 무료 429 정책 구현 명세 확정**  
   - IP당 5회/일, 최초 1회 팝업 + 이후 disabled UX 전이 명문화.
4. **[P0] PAYMENT_IN_PROGRESS 복구 플로우 확정**  
   - 결제 시작/복귀/검증/플래그 제거 시점 정의.
5. **[P0] verify-payment 예외 허용 정책 반영**  
   - PAID + Redis 실패 시 JWT 무조건 발급 분기 명시.
6. **[P0] HS256 보안 기준 확정**  
   - 256-bit 이상 `JWT_SECRET` 운영 규칙 및 로테이션 가이드 초안.
7. **[P0] 유료 카운터 세션 모델 정의**  
   - `q=3,d=1,ttl=86400` 저장 포맷 및 차감 순서(Q1~Q3/d1) 확정.
8. **[P1] paid-summary 카드 생성 규칙 문서화**  
   - Q1~Q2 5장, Q3 보조 1장 규칙을 API 시나리오로 명세.
9. **[P1] paid-detail 1회 소진 UX 플로우 설계**  
   - 버튼 활성/비활성 및 소진 후 안내 카피 확정.
10. **[P1] JWT 실패 비기술 카피 세트 작성**  
    - "기운이 흩어짐" 기반 문구/CTA 990원 카피 확정.
11. **[P1] 카테고리 슬롯 정책 반영**  
    - pinned4 하드코딩 + dynamic2 + LRU 교체 규칙 데이터 구조화.
12. **[P1] 카테고리별 3장/5장 포지션 맵 설계**  
    - 카테고리별 해석 포지션 차등 맵 정의.
13. **[P1] UNLOCK 모션 스펙 고정**  
    - Typewriter(40ms,80자) + 종료 후 pulse(1~2회), reduced-motion 대응 정의.
14. **[P2] 무료 광고 영역 레이아웃 안전장치 설계**  
    - placeholder 고정 높이 및 키보드 활성 숨김 조건 명세.
15. **[P2] 리스크 단어 블랙리스트/가이드/fallback 룰셋 작성**  
    - 차단어, 완곡화 지침, 안전 템플릿 강등 절차 수립.
16. **[P2] 운영 플래그 대응 시나리오 점검표 작성**  
    - `maintenanceMode`, `budgetExhausted`, Redis degraded 대응 문서화.

## 12) 오픈 이슈/가정

- 가정 1: IP 기준 5회/일은 프록시/공유망 오탐을 MVP에서 허용.
- 가정 2: 동적 카테고리 AI 생성 주기는 요청 시점 기반으로 단순화.
- 가정 3: JWT 재발급 정책은 결제 검증 성공 건에 한해 허용.

---
이 문서는 MVP v9 구현 전 기준 설계서이며, 구현 단계에서 API 스키마 변경이 필요하면 본 문서를 먼저 갱신한다.
